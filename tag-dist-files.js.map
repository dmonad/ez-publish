{"version":3,"file":"tag-dist-files.js","sources":["src/tag-dist-files.js"],"sourcesContent":["import program from 'commander'\nimport packageJson from '../package.json'\nimport { posix as path } from 'path'\nimport fs from 'fs'\nimport loadJsonFile from 'load-json-file'\nimport { exec } from 'child_process'\nimport async from 'ez-async'\n\nprocess.on('uncaughtException', function (err) {\n  console.error('An exception was thrown: ', err)\n})\n\nfunction exit (err) {\n  console.error(err)\n  process.exit(1)\n}\n\nprogram\n  .version(packageJson.version)\n  .description(packageJson.description)\n\nprogram.on('--help', function () {\n  console.log(`\n  Example:\n\n    $ tag-dist-files\n\n  `)\n})\n\nvar getPackageJson = async(function * (getCallback, dir) {\n  while (true) {\n    var [err] = yield fs.access(dir, fs.F_OK, getCallback())\n    if (!err) {\n      var pDir = path.join(dir, 'package.json')\n      ;[err] = yield fs.access(pDir, fs.F_OK, getCallback())\n      if (!err) {\n        var p\n        ;[err, p] = yield loadJsonFile(pDir)\n        if (err) exit(err)\n        return [dir, p]\n      } else {\n        dir = path.join(dir, '..')\n      }\n    } else exit('You must specify a package.json file!')\n  }\n})\n\nprogram\n  .arguments('[dir]')\n  .description('Publish the project including distribution files:\\n  Build > version bump > commit > create git tag > publish to npm')\n  .option('-f, --overwrite-existing-tag', 'Overwrite the existing tag')\n  .action(function (dir, command) {\n    async(function * (getCallback) {\n      var p, err, stdout, stderr\n\n      // check for existing package.json\n      ;[err, [dir, p]] = yield getPackageJson(dir || './')\n      if (err != null) exit('package.json does not exist in this directory!')\n\n      // Specify options for calling process\n      var opts = { cwd: dir }\n\n      // Is there a release message?\n      if (!fs.existsSync(path.join(dir, '.releaseMessage'))) {\n        yield exec('echo \"Title\\n\\nDescription\" > .releaseMessage', opts, getCallback())\n      }\n      // open it before publishing?\n      ;[err] = yield exec('xdg-open .releaseMessage', opts, getCallback())\n\n      // read releaseMessage\n      var releaseMessage\n      ;[err, releaseMessage] = yield fs.readFile(path.join(dir, '.releaseMessage'), 'utf8', getCallback())\n      releaseMessage = releaseMessage.split('\\n').filter(line => line[0] !== '#').join('\\n')\n\n      // detach head\n      ;[err, stdout, stderr] = yield exec('git checkout --detach', opts, getCallback())\n      if (err) {\n        exit(`Unable to detach head:\\n\\n${stdout}\\n\\n${stderr}`)\n      } else {\n        console.log('✓ Detach head')\n      }\n      var releasefilesAdded = false\n      var files = p.files || []\n\n      // add dist files\n      for (var i = 0; i < files.length; i++) {\n        ;[err, stdout, stderr] = yield exec(`git add ${files[i]} -f`, opts, getCallback())\n        if (err) {\n          console.warn(`❌ Failed to add ${files[i]} to index`)\n        } else {\n          releasefilesAdded = true\n          console.log(`✓ Add ${files[i]} to index`)\n        }\n      }\n\n      if (releasefilesAdded) {\n        // commit dist files\n        ;[err, stdout, stderr] = yield exec(`git commit -am \"v${p.version} -- distribution files\"`, opts, getCallback())\n        if (err) {\n          exit(`Unable to commit dist files:\\n\\n${stdout}\\n\\n${stderr}`)\n        } else {\n          console.log('✓ Commit dist files')\n        }\n      }\n\n      // remove existing tags (e.g. created by np)\n      if (command.overwriteExistingTag) {\n        yield exec(`git tag -d v${p.version}`, opts, getCallback())\n        yield exec(`git push origin :refs/tags/v${p.version}`, opts, getCallback())\n      }\n\n      // tag releasefiles\n      ;[err, stdout, stderr] = yield exec(`git tag v${p.version} -m \"${releaseMessage}\"`, opts, getCallback())\n      if (err) {\n        exit(`Unable to tag commit:\\n\\n${stdout}\\n\\n${stderr}`)\n      } else {\n        console.log('✓ Tag release')\n      }\n\n      // push tag\n      ;[err, stdout, stderr] = yield exec(`git push origin v${p.version}`, opts, getCallback())\n      if (err) {\n        exit(`Unable to tag commit:\\n\\n${stdout}\\n\\n${stderr}`)\n      } else {\n        console.log('✓ Push tag')\n      }\n\n      // check out master\n      ;[err, stdout, stderr] = yield exec('git checkout master', opts, getCallback())\n      if (err) {\n        exit(`Unable to checkout branch 'master':\\n\\n${stdout}\\n\\n${stderr}`)\n      } else {\n        console.log('✓ Checkout master branch')\n        yield exec('rm .releaseMessage', opts, getCallback())\n        process.exit(0)\n      }\n    })()\n  })\n\nvar args = process.argv\nif (args.every((arg, i) => i < 2 || arg[0] === '-')) {\n  args.push('.')\n}\n\nprogram\n  .parse(process.argv)\n\nif (!program.args.length) program.help()\n"],"names":["process","on","err","error","exit","program","version","packageJson","description","log","getPackageJson","async","getCallback","dir","fs","access","F_OK","pDir","path","join","p","loadJsonFile","arguments","option","action","command","stdout","stderr","opts","cwd","existsSync","exec","releaseMessage","readFile","split","filter","line","releasefilesAdded","files","i","length","warn","overwriteExistingTag","args","argv","every","arg","push","parse","help"],"mappings":"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"}