{"version":3,"file":"tag-dist-files.js","sources":["src/tag-dist-files.js"],"sourcesContent":["import 'regenerator-runtime/runtime'\nimport program from 'commander'\nimport packageJson from '../package.json'\nimport { posix as path } from 'path'\nimport fs from 'fs'\nimport loadJsonFile from 'load-json-file'\nimport { exec } from 'child_process'\nimport async from 'ez-async'\n\nprocess.on('uncaughtException', function (err) {\n  console.error('An exception was thrown: ', err)\n})\n\nprogram\n  .version(packageJson.version)\n  .description(packageJson.description)\n\nprogram.on('--help', function () {\n  console.log(`\n  Example:\n\n    $ tag-dist-files\n\n  `)\n})\n\nprogram\n  .arguments('[dir]')\n  .description('Publish the project including distribution files:\\n  Build > version bump > commit > create git tag > publish to npm')\n  .option('-f, --overwrite-existing-tag', 'Overwrite the existing tag')\n  .action(function (dir, command) {\n    // Specify options for calling process\n    var opts = { cwd: dir }\n\n    async(function * (getCallback) {\n      function * exit (err) {\n        console.error(err)\n        // move back from backup\n        for (i = 0; i < files.length; i++) {\n          yield exec(`rm -rf ${files[i]} && cp -rf .tag-dist-files-backup/${files[i]} .`, opts, getCallback())\n        }\n        yield exec('rm -rf .tag-dist-files-backup', opts, getCallback())\n\n        console.log('Reverting to master branch')\n        yield exec('git checkout master', opts, getCallback())\n        process.exit(1)\n      }\n\n      var getPackageJson = async(function * (getCallback, dir) {\n        while (true) {\n          var [err] = yield fs.access(dir, fs.F_OK, getCallback())\n          if (!err) {\n            var pDir = path.join(dir, 'package.json')\n            ;[err] = yield fs.access(pDir, fs.F_OK, getCallback())\n            if (!err) {\n              var p\n              ;[err, p] = yield loadJsonFile(pDir)\n              if (err) yield * exit(err)\n              return [dir, p]\n            } else {\n              dir = path.join(dir, '..')\n            }\n          } else yield * exit('You must specify a package.json file!')\n        }\n      })\n\n      var p, err, stdout, stderr\n\n      // check for existing package.json\n      ;[err, [dir, p]] = yield getPackageJson(dir || './')\n      if (err != null) {\n        console.error('package.json does not exist in this directory!')\n        process.exit(1)\n      }\n\n      // Is there a release message?\n      if (!fs.existsSync(path.join(dir, '.releaseMessage'))) {\n        yield exec('echo \"Title\\n\\nDescription\" > .releaseMessage', opts, getCallback())\n      }\n      // open it before publishing?\n      ;[err] = yield exec('xdg-open .releaseMessage', opts, getCallback())\n\n      // read releaseMessage\n      var releaseMessage\n      ;[err, releaseMessage] = yield fs.readFile(path.join(dir, '.releaseMessage'), 'utf8', getCallback())\n      releaseMessage = releaseMessage.split('\\n').filter(line => line[0] !== '#').join('\\n')\n\n      // detach head\n      ;[err, stdout, stderr] = yield exec('git checkout --detach', opts, getCallback())\n      if (err) {\n        yield * exit(`Unable to detach head:\\n\\n${stdout}\\n\\n${stderr}`)\n      } else {\n        console.log('✓ Detach head')\n      }\n      var releasefilesAdded = false\n      var files = p.files || []\n\n      yield exec('mkdir -p .tag-dist-files-backup', opts, getCallback())\n      // add dist files\n      for (var i = 0; i < files.length; i++) {\n        yield exec(`cp ${files[i]} -rf .tag-dist-files-backup`, opts, getCallback())\n        ;[err, stdout, stderr] = yield exec(`git add ${files[i]} -f`, opts, getCallback())\n        if (err) {\n          console.warn(`❌ Failed to add ${files[i]} to index`)\n        } else {\n          releasefilesAdded = true\n          console.log(`✓ Add ${files[i]} to index`)\n        }\n      }\n\n      if (releasefilesAdded) {\n        // commit dist files\n        ;[err, stdout, stderr] = yield exec(`git commit -am \"v${p.version} -- distribution files\"`, opts, getCallback())\n        if (err) {\n          yield * exit(`Unable to commit dist files:\\n\\n${stdout}\\n\\n${stderr}`)\n        } else {\n          console.log('✓ Commit dist files')\n        }\n      }\n\n      // remove existing tags (e.g. created by np)\n      if (command.overwriteExistingTag) {\n        yield exec(`git tag -d v${p.version}`, opts, getCallback())\n        yield exec(`git push origin :refs/tags/v${p.version}`, opts, getCallback())\n      }\n\n      // tag releasefiles\n\n      // escape \" characters in releaseMessage\n      releaseMessage = releaseMessage.split('\"').join('\\\\\"')\n      ;[err, stdout, stderr] = yield exec(`git tag v${p.version} -m \"${releaseMessage}\"`, opts, getCallback())\n      if (err) {\n        yield * exit(`Unable to tag commit:\\n\\n${stdout}\\n\\n${stderr}`)\n      } else {\n        console.log('✓ Tag release')\n      }\n\n      // push tag\n      ;[err, stdout, stderr] = yield exec(`git push origin v${p.version}`, opts, getCallback())\n      if (err) {\n        yield * exit(`Unable to tag commit:\\n\\n${stdout}\\n\\n${stderr}`)\n      } else {\n        console.log('✓ Push tag')\n      }\n\n      // check out master\n      ;[err, stdout, stderr] = yield exec('git checkout master', opts, getCallback())\n      if (err) {\n        yield * exit(`Unable to checkout branch 'master':\\n\\n${stdout}\\n\\n${stderr}`)\n      } else {\n        console.log('✓ Checkout master branch')\n        // move back from backup\n        for (i = 0; i < files.length; i++) {\n          // we cp because it is less likely to fail\n          yield exec(`rm -rf ${files[i]} && cp -rf .tag-dist-files-backup/${files[i]} .`, opts, getCallback())\n        }\n        yield exec('rm -rf .tag-dist-files-backup', opts, getCallback())\n        yield exec('rm .releaseMessage', opts, getCallback())\n        process.exit(0)\n      }\n    })()\n  })\n\nvar args = process.argv\nif (args.every((arg, i) => i < 2 || arg[0] === '-')) {\n  args.push('.')\n}\n\nprogram\n  .parse(process.argv)\n\nif (!program.args.length) program.help()\n"],"names":["process","on","err","error","program","version","packageJson","description","log","arguments","option","action","dir","command","opts","cwd","getCallback","exit","i","files","length","exec","async","fs","access","F_OK","path","join","pDir","loadJsonFile","p","getPackageJson","existsSync","readFile","releaseMessage","split","filter","line","stdout","stderr","warn","releasefilesAdded","overwriteExistingTag","args","argv","every","arg","push","parse","help"],"mappings":"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"}